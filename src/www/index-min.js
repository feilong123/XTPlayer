var remoteUserSettings,playingmediaItem,playingmediaItemNode,thumbsContainerNode,settingsNode,videoNode,videoSourceNode,externalStreaming,resizeObserver,webSocket,deviceAddress,deviceConnectionStatusInterval,deviceConnectionStatusRetryButtonNode,deviceConnectionStatusRetryButtonImageNode,DeviceType={Serial:0,Network:1,Deo:2,Whirligig:3,Gamepad:4,XTPWeb:5},ConnectionStatus={Connected:0,Disconnected:1,Connecting:2,Error:3},ChannelType={None:0,Range:1,Switch:2,HalfRange:3},AxisDimension={None:0,Heave:1,Surge:2,Sway:3,Pitch:4,Roll:5,Yaw:6},mediaListObj=[],sortByGlobal="nameAsc",showGlobal="All",thumbSizeGlobal=0,funscriptChannels=[],currentChannelIndex=0,connectionStatus=ConnectionStatus.Disconnected;function loadPage(){settingsNode=document.getElementById("settingsModal"),thumbsContainerNode=document.getElementById("thumbsContainer"),sortByGlobal=JSON.parse(window.localStorage.getItem("sortBy")),showGlobal=JSON.parse(window.localStorage.getItem("show")),thumbSizeGlobal=JSON.parse(window.localStorage.getItem("thumbSize"));var e=JSON.parse(window.localStorage.getItem("volume"));externalStreaming=JSON.parse(window.localStorage.getItem("externalStreaming")),videoNode=document.getElementById("videoPlayer"),videoSourceNode=document.getElementById("videoSource"),videoNode.addEventListener("timeupdate",onVideoTimeUpdate),videoNode.addEventListener("loadeddata",onVideoLoad),videoNode.addEventListener("play",onVideoPlay),videoNode.addEventListener("pause",onVideoPause),videoNode.addEventListener("volumechange",onVolumeChange),videoNode.addEventListener("ended",onVideoEnd),videoNode.volume=e||.5,deviceConnectionStatusRetryButtonNode=document.getElementById("deviceStatusRetryButton"),deviceConnectionStatusRetryButtonImageNode=document.getElementById("connectionStatusIconImage"),toggleExternalStreaming(externalStreaming,!1),getServerSettings(),userGetDeviceConnectionStatus()}function onResizeVideo(){thumbsContainerNode.style.maxHeight="calc(100vh - "+(+videoNode.offsetHeight+165)+"px)"}function getServerSettings(){var e=new XMLHttpRequest;e.open("GET","/settings",!0),e.responseType="json",e.onload=function(){200===e.status?(remoteUserSettings=e.response,funscriptChannels=Object.keys(remoteUserSettings.availableAxis).map((function(e){return remoteUserSettings.availableAxis[e].channel})),remoteUserSettings.availableAxisArray=Object.keys(remoteUserSettings.availableAxis).map((function(e){return remoteUserSettings.availableAxis[e]})),funscriptChannels.sort(),updateSettingsUI(),getServerLibrary()):alert("Error getting settings")},e.send()}function updateSettingsUI(){setupSliders()}function getServerLibrary(){var e=new XMLHttpRequest;e.open("GET","/media",!0),e.responseType="json",e.onload=function(){var t=e.status;onMediaLoad(200===t?null:t,e.response)},e.onerror=function(){alert("Error getting media")},e.send()}function setConnectionStatus(e,t){switch(deviceConnectionStatusRetryButtonNode.title="TCode status: "+t,deviceConnectionStatusRetryButtonNode.style.cursor="",deviceConnectionStatusRetryButtonNode.disabled=!0,e){case ConnectionStatus.Disconnected:deviceConnectionStatusRetryButtonNode.style.backgroundColor="crimson",deviceConnectionStatusRetryButtonNode.style.cursor="pointer",deviceConnectionStatusRetryButtonNode.disabled=!1,deviceConnectionStatusRetryButtonImageNode.src="://images/icons/x.png",deviceConnectionStatusRetryButtonNode.title+=": Check your devices connection and click this to retry";break;case ConnectionStatus.Connecting:deviceConnectionStatusRetryButtonNode.style.backgroundColor="yellow",deviceConnectionStatusRetryButtonImageNode.src="://images/icons/reload.svg";break;case ConnectionStatus.Connected:deviceConnectionStatusRetryButtonNode.style.backgroundColor="chartreuse",deviceConnectionStatusRetryButtonImageNode.src="://images/icons/check-mark-black.png";break;case ConnectionStatus.Error:deviceConnectionStatusRetryButtonNode.style.backgroundColor="red",deviceConnectionStatusRetryButtonNode.style.cursor="pointer",deviceConnectionStatusRetryButtonNode.disabled=!1,deviceConnectionStatusRetryButtonImageNode.src="://images/icons/error-black.png",deviceConnectionStatusRetryButtonNode.title+=": Check your devices connection and click this to retry";break}}function getDeviceConnectionStatus(){deviceConnectionStatusInterval&&clearTimeout(deviceConnectionStatusInterval);var e=new XMLHttpRequest;e.open("GET","/settings/deviceConnectionStatus",!0),e.responseType="json",e.onload=function(){var t=e.status;if(200===t){var n=e.response;setConnectionStatus(connectionStatus=n.status,n.message),pollDeviceConnectionStatus(3e4),connectionStatus==ConnectionStatus.Connecting&&pollDeviceConnectionStatus(1e3)}else alert("Http Error getting device connection status: "+t),deviceConnectionStatusInterval&&clearTimeout(deviceConnectionStatusInterval),setConnectionStatus(ConnectionStatus.Error,"Http Error getting device connection status: "+t)},e.onerror=function(){var t=e.status;alert("Error getting device connection status: "+t),deviceConnectionStatusInterval&&clearTimeout(deviceConnectionStatusInterval),setConnectionStatus(ConnectionStatus.Error,"Error getting device connection status: "+t)},e.send()}function pollDeviceConnectionStatus(e){deviceConnectionStatusInterval&&(clearTimeout(deviceConnectionStatusInterval),deviceConnectionStatusInterval=null),deviceConnectionStatusInterval=setTimeout((function(){getDeviceConnectionStatus()}),e)}function userGetDeviceConnectionStatus(){setConnectionStatus(ConnectionStatus.Connecting,"Getting device connection status..."),getDeviceConnectionStatus()}function getMediaFunscripts(e,t){var n=funscriptChannels[currentChannelIndex],i=remoteUserSettings.availableAxis[n].trackName,o=new XMLHttpRequest,a=""===i?i:"."+i;o.open("GET",e+a+".funscript",!0),o.responseType="json",o.onload=function(){if(200===o.status){loadedFunscripts.push({channel:n,atList:[]});for(var i=loadedFunscripts.length-1,a=o.response,s=0;s<a.actions.length;s++){var r=a.actions[s],d=r.at;loadedFunscripts[i][d]=r.pos,loadedFunscripts[i].atList.push(d)}}++currentChannelIndex<funscriptChannels.length?getMediaFunscripts(e,t):(currentChannelIndex=0,videoNode.play())},o.send()}function postServerSettings(){var e=new XMLHttpRequest;e.open("POST","/settings",!0),e.setRequestHeader("Content-Type","application/json"),e.onreadystatechange=function(){if(4===e.readyState){var t=e.status;200!==t&&alert("Error saving server settings: "+t)}},e.onerror=function(){var t=e.status;alert("Error saving server settings: "+t)},e.send(JSON.stringify(remoteUserSettings))}function postDeviceConnectRetry(){var e=new XMLHttpRequest;e.open("POST","/settings/connectDevice",!0),e.onreadystatechange=function(){if(4===e.readyState){var t=e.status;200===t?userGetDeviceConnectionStatus():alert("Error sending retry device connection: "+t)}},e.onerror=function(){var t=e.status;alert("Error sending retry device connection: "+t)},e.send()}function postMediaState(e){var t=new XMLHttpRequest;t.open("POST","/xtpweb",!0),t.setRequestHeader("Content-Type","application/json"),t.send(JSON.stringify(e)),t.oneload=function(){t.status},t.onerror=function(){t.status}}function onMediaLoad(e,t){if(null!==e)alert("Whoops!: "+e);else{mediaListObj=[];for(var n=0;n<t.length;n++){var i={id:t[n].name.replace(/^[^a-z]+|[^\w:.-]+/gi,"")+"item"+n,name:t[n].name,displayName:t[n].name,thumbSize:t[n].thumbSize,path:t[n].path,relativePath:t[n].relativePath,thumb:t[n].thumb,relativeThumb:t[n].relativeThumb,modifiedDate:new Date(t[n].modifiedDate),isStereoscopic:t[n].isStereoscopic,isMFS:t[n].isMFS,hasScript:t[n].hasScript,scriptNoExtensionRelativePath:t[n].scriptNoExtensionRelativePath,loaded:!1,playing:!1};i.isMFS&&(i.displayName="(MFS) "+i.name),mediaListObj.push(i)}updateMediaUI()}}function updateMediaUI(){setThumbSize(thumbSizeGlobal,!1),sort(sortByGlobal,!1),loadMedia(show(showGlobal,!1))}function loadMedia(e){var t=document.getElementById("mediaList");if(removeAllChildNodes(t),!e||0==e.length)return(c=document.createElement("div")).id="NoMedia",c.innerText="No media found, it may be loading.",void t.appendChild(c);var n=document.getElementById("NoMedia");n&&t.removeChild(n);for(var i=function(e){return function(){playVideo(e)}},o=0,a=0,s=0,r=0,d=0;d<e.length;d++){var c,l=e[d];thumbSizeGlobal||(setThumbSize(l.thumbSize,!0),setThumbSize(l.thumbSize,!1)),o||(a=thumbSizeGlobal+.15*thumbSizeGlobal+"px",s=thumbSizeGlobal+(o=.25*thumbSizeGlobal)+"px",r=.3*o+"px"),(c=document.createElement("div")).id=l.id,c.className+="media-item",c.style.width=a,c.style.height=s,c.title=l.name;var u=document.createElement("a");u.className+="media-link",l.isMFS&&(c.className+=" media-item-mfs"),l.hasScript||(c.className+=" media-item-noscript"),u.onclick=i(l);var m=document.createElement("img");m.src="/thumb/"+l.relativeThumb,m.style.maxWidth=thumbSizeGlobal+"px",m.style.maxHeight=thumbSizeGlobal+"px",m.id=l.id;var v=document.createElement("div");v.innerText=l.displayName,v.className+="name",v.style.width=a,v.style.height=o+"px",v.style.fontSize=r,c.appendChild(u),u.appendChild(m),u.appendChild(v),t.appendChild(c),playingmediaItem&&playingmediaItem.id===l.id&&setPlayingMediaItem(l)}}function removeAllChildNodes(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function sort(e,t){switch(e||(e="nameAsc"),e){case"dateDesc":mediaListObj.sort((function(e,t){return new Date(t.modifiedDate)-new Date(e.modifiedDate)}));break;case"dateAsc":mediaListObj.sort((function(e,t){return new Date(e.modifiedDate)-new Date(t.modifiedDate)}));break;case"nameAsc":mediaListObj.sort((function(e,t){var n=e.displayName.toUpperCase(),i=t.displayName.toUpperCase();return n<i?-1:n>i?1:void 0}));break;case"nameDesc":mediaListObj.sort((function(e,t){var n=e.displayName.toUpperCase(),i=t.displayName.toUpperCase();return i<n?-1:i>n?1:void 0}));break}t?(window.localStorage.setItem("sortBy",JSON.stringify(e)),sortByGlobal=e):document.getElementById("sortBy").value=e}function show(e,t){switch(e||(e="All"),filteredMedia=[],e){case"All":filteredMedia=mediaListObj;break;case"3DOnly":filteredMedia=mediaListObj.filter((e=>e.isStereoscopic));break;case"2DAndAudioOnly":filteredMedia=mediaListObj.filter((e=>!e.isStereoscopic));break}return t?(window.localStorage.setItem("show",JSON.stringify(e)),showGlobal=e):document.getElementById("show").value=e,filteredMedia}function onClickExternalStreamingCheckbox(e){toggleExternalStreaming(e.checked,!0)}function toggleExternalStreaming(e,t){t?(externalStreaming=e,window.localStorage.setItem("externalStreaming",JSON.stringify(e))):document.getElementById("externalStreamingCheckbox").checked=e,e?(videoNode.pause(),videoNode.classList.remove("video-shown"),thumbsContainerNode.style.maxHeight="",playingmediaItem&&clearPlayingMediaItem(),resizeObserver&&resizeObserver.unobserve(videoNode)):(onResizeVideo(),(resizeObserver=new ResizeObserver(onResizeVideo)).observe(videoNode))}function playVideo(e){if(externalStreaming)window.open("/video"+e.relativePath);else{if(playingmediaItem){if(playingmediaItem.id===e.id)return;clearPlayingMediaItem()}setPlayingMediaItem(e),videoNode.classList.add("video-shown"),videoSourceNode.setAttribute("src","/video"+e.relativePath),videoNode.setAttribute("title",e.name),videoNode.setAttribute("poster","/thumb/"+e.relativeThumb),videoNode.load(),videoNode.play()}}function setPlayingMediaItem(e){playingmediaItem=e,(playingmediaItemNode=document.getElementById(e.id)).classList.add("media-item-playing")}function clearPlayingMediaItem(){playingmediaItemNode.classList.remove("media-item-playing"),playingmediaItem=null,playingmediaItemNode=null}document.addEventListener("DOMContentLoaded",(function(){loadPage()}));var debouncer,timer1=0,timer2=Date.now();function onVideoTimeUpdate(e){timer2-timer1>=1e3&&(timer1=timer2,sendMediaState()),timer2=Date.now()}function onVideoLoad(e){playingmediaItem.loaded=!0}function onVideoPlay(e){playingmediaItem.playing=!0}function onVideoPause(e){playingmediaItem.playing=!1,sendMediaState()}function onVolumeChange(){window.localStorage.setItem("volume",videoNode.volume)}function onVideoEnd(e){var t=mediaListObj.findIndex((e=>e.path===playingmediaItem.path));++t<mediaListObj.length?playVideo(mediaListObj[t]):playVideo(mediaListObj[0])}function setThumbSize(e,t){t?(window.localStorage.setItem("thumbSize",parseInt(e,10)),thumbSizeGlobal=parseInt(e,10)):e&&(document.getElementById("thumbSize").value=e.toString())}function sendMediaState(){playingmediaItem&&postMediaState({path:playingmediaItem.path,playing:playingmediaItem.playing,currentTime:videoNode.currentTime,duration:videoNode.duration,playbackSpeed:videoNode.speed})}function onFunscriptWorkerThreadRecieveMessage(e){var t;switch(isMediaFunscriptPlaying=!0,(t="string"==typeof e.data?JSON.parse(e.data):e.data).command){case"sendTcode":sendTcode(t.tcode);break;case"getMediaState":sendMediaState();break;case"end":funscriptSyncWorker.terminate(),funscriptSyncWorker=null;break}}function openSettings(){settingsNode.style.visibility="visible",settingsNode.style.opacity=1}function closeSettings(){settingsNode.style.visibility="hidden",settingsNode.style.opacity=0}function showChange(e){sort(sortByGlobal,!0),loadMedia(show(e.value,!0))}function sortChange(e){sort(e.value,!0),loadMedia(show(showGlobal,!0))}function thumbSizeChange(e){setThumbSize(e.value,!0),loadMedia(show(showGlobal,!0))}function setupSliders(){for(var e=remoteUserSettings.availableAxisArray,t=document.getElementById("modalBody"),n=0;n<e.length;n++){var i=e[n],o=document.createElement("div");o.classList.add("formElement");var a=document.createElement("label");a.classList.add("range-label"),a.innerText=i.friendlyName,a.for=i.channel,o.appendChild(a);var s=document.createElement("section");s.id=i.channel,s.classList.add("range-slider"),o.appendChild(s);var r=document.createElement("span");r.classList.add("range-values"),s.appendChild(r);var d=document.createElement("input");d.classList.add("range-min"),d.type="range",d.min=i.min,d.max=i.userMax-1,d.value=i.userMin;var c=document.createElement("input");c.classList.add("range-max"),c.type="range",c.min=i.userMin+1,c.max=i.max,c.value=i.userMax,d.oninput=function(e,t,n,i){var o=parseFloat(e.value),a=parseFloat(t.value),s=Math.round((a+o)/2);n.innerText=o+" - "+s+" - "+a,e.max=a-1,remoteUserSettings.availableAxis[i.channel].userMin=o,remoteUserSettings.availableAxis[i.channel].userMid=s}.bind(d,d,c,r,i),c.oninput=function(e,t,n,i){var o=parseFloat(e.value),a=parseFloat(t.value),s=Math.round((a+o)/2);n.innerText=o+" - "+s+" - "+a,t.min=o+1,remoteUserSettings.availableAxis[i.channel].userMax=a,remoteUserSettings.availableAxis[i.channel].userMid=s}.bind(c,d,c,r,i),s.appendChild(d),s.appendChild(c),d.oninput(),c.oninput(),t.appendChild(o)}}function webSocketAddressChange(e){debouncer&&clearTimeout(debouncer),debouncer=setTimeout((function(){debouncer=null,deviceAddress=document.getElementById("webSocketAddress").value,window.localStorage.setItem("webSocketAddress",value)}),500)}function defaultLocalSettings(){confirm("Are you sure you want to reset ALL local settings to default? Note: This only resets the settings in this browser. Your settings stored in XTP will remain.")&&(window.localStorage.clear(),window.location.reload())}function deleteLocalSettings(){confirm("Are you sure you want to delete ALL settings from localStorage and close the window?")&&(window.localStorage.clear(),window.close())}